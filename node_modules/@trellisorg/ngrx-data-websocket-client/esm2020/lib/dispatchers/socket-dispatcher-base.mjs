import { OP_ERROR, OP_SUCCESS, } from '@ngrx/data';
import { SocketOp, } from '@trellisorg/ngrx-data-websocket-core';
import { of, throwError } from 'rxjs';
import { filter, mergeMap, take, timeout } from 'rxjs/operators';
export class SocketDispatcherBase {
    constructor(entityName, correlationIdGenerator, socketActionFactory, reducedActions$, store, socketTimeout) {
        this.entityName = entityName;
        this.correlationIdGenerator = correlationIdGenerator;
        this.socketActionFactory = socketActionFactory;
        this.reducedActions$ = reducedActions$;
        this.store = store;
        this.socketTimeout = socketTimeout;
    }
    createSocketAction(socketOp, data, options) {
        return this.socketActionFactory.create(this.entityName, socketOp, data, options);
    }
    dispatch(action) {
        this.store.dispatch(action);
        return action;
    }
    add(entity) {
        return this.processEvent(SocketOp.SAVE_ADD_ONE, entity);
    }
    delete(id) {
        return this.processEvent(SocketOp.SAVE_DELETE_ONE, id);
    }
    getAll() {
        return this.processEvent(SocketOp.QUERY_ALL);
    }
    getById(id) {
        return this.processEvent(SocketOp.QUERY_BY_KEY, id);
    }
    getWithQuery(params) {
        return this.processEvent(SocketOp.QUERY_MANY, params);
    }
    update(update) {
        return this.processEvent(SocketOp.SAVE_UPDATE_ONE, update);
    }
    upsert(entity) {
        return this.processEvent(SocketOp.SAVE_UPSERT_ONE, entity);
    }
    processEvent(event, data) {
        const correlationId = this.correlationIdGenerator.next();
        const action = this.socketActionFactory.create(this.entityName, event, data, { correlationId });
        this.dispatch(action);
        return this.getResponseEventData$(correlationId);
    }
    getResponseEventData$(crid) {
        return this.reducedActions$.pipe(filter((act) => !!act.payload), filter((act) => {
            const { correlationId, entityName, socketOp } = act.payload;
            return (entityName === this.entityName &&
                correlationId === crid &&
                (socketOp.endsWith(OP_SUCCESS) ||
                    socketOp.endsWith(OP_ERROR)));
        }), timeout(this.socketTimeout), take(1), mergeMap((act) => {
            const { socketOp } = act.payload;
            return socketOp.endsWith(OP_SUCCESS)
                ? of(act.payload.data)
                : throwError(act.payload.data.error);
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LWRpc3BhdGNoZXItYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL25ncngtZGF0YS13ZWJzb2NrZXQvY2xpZW50L3NyYy9saWIvZGlzcGF0Y2hlcnMvc29ja2V0LWRpc3BhdGNoZXItYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUgsUUFBUSxFQUNSLFVBQVUsR0FFYixNQUFNLFlBQVksQ0FBQztBQUdwQixPQUFPLEVBR0gsUUFBUSxHQUNYLE1BQU0sc0NBQXNDLENBQUM7QUFDOUMsT0FBTyxFQUFjLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR2pFLE1BQU0sT0FBTyxvQkFBb0I7SUFDN0IsWUFDWSxVQUFrQixFQUNsQixzQkFBOEMsRUFDOUMsbUJBQXdDLEVBQ3hDLGVBQW1DLEVBQ25DLEtBQVksRUFDWixhQUFxQjtRQUxyQixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBQ2xCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxvQkFBZSxHQUFmLGVBQWUsQ0FBb0I7UUFDbkMsVUFBSyxHQUFMLEtBQUssQ0FBTztRQUNaLGtCQUFhLEdBQWIsYUFBYSxDQUFRO0lBQzlCLENBQUM7SUFFSixrQkFBa0IsQ0FDZCxRQUFrQixFQUNsQixJQUFRLEVBQ1IsT0FBNkI7UUFFN0IsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUNsQyxJQUFJLENBQUMsVUFBVSxFQUNmLFFBQVEsRUFDUixJQUFJLEVBQ0osT0FBTyxDQUNWLENBQUM7SUFDTixDQUFDO0lBRU8sUUFBUSxDQUFDLE1BQWM7UUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FB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b3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIENvcnJlbGF0aW9uSWRHZW5lcmF0b3IsXG4gICAgT1BfRVJST1IsXG4gICAgT1BfU1VDQ0VTUyxcbiAgICBRdWVyeVBhcmFtcyxcbn0gZnJvbSAnQG5ncngvZGF0YSc7XG5pbXBvcnQgdHlwZSB7IFVwZGF0ZVN0ciB9IGZyb20gJ0BuZ3J4L2VudGl0eS9zcmMvbW9kZWxzJztcbmltcG9ydCB0eXBlIHsgQWN0aW9uLCBTdG9yZSB9IGZyb20gJ0BuZ3J4L3N0b3JlJztcbmltcG9ydCB7XG4gICAgU29ja2V0QWN0aW9uLFxuICAgIFNvY2tldEFjdGlvbk9wdGlvbnMsXG4gICAgU29ja2V0T3AsXG59IGZyb20gJ0B0cmVsbGlzb3JnL25ncngtZGF0YS13ZWJzb2NrZXQtY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtZXJnZU1hcCwgdGFrZSwgdGltZW91dCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB0eXBlIHsgU29ja2V0QWN0aW9uRmFjdG9yeSB9IGZyb20gJy4uL2FjdGlvbnMvc29ja2V0LWFjdGlvbi1mYWN0b3J5JztcblxuZXhwb3J0IGNsYXNzIFNvY2tldERpc3BhdGNoZXJCYXNlPFQ+IHtcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBlbnRpdHlOYW1lOiBzdHJpbmcsXG4gICAgICAgIHByaXZhdGUgY29ycmVsYXRpb25JZEdlbmVyYXRvcjogQ29ycmVsYXRpb25JZEdlbmVyYXRvcixcbiAgICAgICAgcHJpdmF0ZSBzb2NrZXRBY3Rpb25GYWN0b3J5OiBTb2NrZXRBY3Rpb25GYWN0b3J5LFxuICAgICAgICBwcml2YXRlIHJlZHVjZWRBY3Rpb25zJDogT2JzZXJ2YWJsZTxBY3Rpb24+LFxuICAgICAgICBwcml2YXRlIHN0b3JlOiBTdG9yZSxcbiAgICAgICAgcHJpdmF0ZSBzb2NrZXRUaW1lb3V0OiBudW1iZXJcbiAgICApIHt9XG5cbiAgICBjcmVhdGVTb2NrZXRBY3Rpb248UCA9IGFueT4oXG4gICAgICAgIHNvY2tldE9wOiBTb2NrZXRPcCxcbiAgICAgICAgZGF0YT86IFAsXG4gICAgICAgIG9wdGlvbnM/OiBTb2NrZXRBY3Rpb25PcHRpb25zXG4gICAgKTogU29ja2V0QWN0aW9uPFA+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc29ja2V0QWN0aW9uRmFjdG9yeS5jcmVhdGUoXG4gICAgICAgICAgICB0aGlzLmVudGl0eU5hbWUsXG4gICAgICAgICAgICBzb2NrZXRPcCxcbiAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICBvcHRpb25zXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkaXNwYXRjaChhY3Rpb246IEFjdGlvbik6IEFjdGlvbiB7XG4gICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goYWN0aW9uKTtcbiAgICAgICAgcmV0dXJuIGFjdGlvbjtcbiAgICB9XG5cbiAgICBhZGQoZW50aXR5OiBUKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NFdmVudChTb2NrZXRPcC5TQVZFX0FERF9PTkUsIGVudGl0eSk7XG4gICAgfVxuXG4gICAgZGVsZXRlKGlkOiBudW1iZXIgfCBzdHJpbmcpOiBPYnNlcnZhYmxlPG51bWJlciB8IHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9jZXNzRXZlbnQ8bnVtYmVyIHwgc3RyaW5nLCBudW1iZXIgfCBzdHJpbmc+KFxuICAgICAgICAgICAgU29ja2V0T3AuU0FWRV9ERUxFVEVfT05FLFxuICAgICAgICAgICAgaWRcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBnZXRBbGwoKTogT2JzZXJ2YWJsZTxUW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc0V2ZW50PG51bGwsIFRbXT4oU29ja2V0T3AuUVVFUllfQUxMKTtcbiAgICB9XG5cbiAgICBnZXRCeUlkKGlkOiBudW1iZXIgfCBzdHJpbmcpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc0V2ZW50PG51bWJlciB8IHN0cmluZywgVD4oU29ja2V0T3AuUVVFUllfQllfS0VZLCBpZCk7XG4gICAgfVxuXG4gICAgZ2V0V2l0aFF1ZXJ5KHBhcmFtczogUXVlcnlQYXJhbXMgfCBzdHJpbmcpOiBPYnNlcnZhYmxlPFRbXT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9jZXNzRXZlbnQ8UXVlcnlQYXJhbXMgfCBzdHJpbmcsIFRbXT4oXG4gICAgICAgICAgICBTb2NrZXRPcC5RVUVSWV9NQU5ZLFxuICAgICAgICAgICAgcGFyYW1zXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgdXBkYXRlKHVwZGF0ZTogVXBkYXRlU3RyPFQ+KTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NFdmVudDxVcGRhdGVTdHI8VD4sIFQ+KFxuICAgICAgICAgICAgU29ja2V0T3AuU0FWRV9VUERBVEVfT05FLFxuICAgICAgICAgICAgdXBkYXRlXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgdXBzZXJ0KGVudGl0eTogVCk6IE9ic2VydmFibGU8VD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9jZXNzRXZlbnQ8VCwgVD4oU29ja2V0T3AuU0FWRV9VUFNFUlRfT05FLCBlbnRpdHkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc0V2ZW50PFAsIEs+KGV2ZW50OiBTb2NrZXRPcCwgZGF0YT86IFApOiBPYnNlcnZhYmxlPEs+IHtcbiAgICAgICAgY29uc3QgY29ycmVsYXRpb25JZCA9IHRoaXMuY29ycmVsYXRpb25JZEdlbmVyYXRvci5uZXh0KCk7XG5cbiAgICAgICAgY29uc3QgYWN0aW9uID0gdGhpcy5zb2NrZXRBY3Rpb25GYWN0b3J5LmNyZWF0ZTxQPihcbiAgICAgICAgICAgIHRoaXMuZW50aXR5TmFtZSxcbiAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgIHsgY29ycmVsYXRpb25JZCB9XG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5kaXNwYXRjaChhY3Rpb24pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmdldFJlc3BvbnNlRXZlbnREYXRhJDxLPihjb3JyZWxhdGlvbklkKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFJlc3BvbnNlRXZlbnREYXRhJDxEID0gYW55PihjcmlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVkdWNlZEFjdGlvbnMkLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKGFjdDogYW55KSA9PiAhIWFjdC5wYXlsb2FkKSxcbiAgICAgICAgICAgIGZpbHRlcigoYWN0OiBTb2NrZXRBY3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB7IGNvcnJlbGF0aW9uSWQsIGVudGl0eU5hbWUsIHNvY2tldE9wIH0gPSBhY3QucGF5bG9hZDtcbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHlOYW1lID09PSB0aGlzLmVudGl0eU5hbWUgJiZcbiAgICAgICAgICAgICAgICAgICAgY29ycmVsYXRpb25JZCA9PT0gY3JpZCAmJlxuICAgICAgICAgICAgICAgICAgICAoc29ja2V0T3AuZW5kc1dpdGgoT1BfU1VDQ0VTUykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldE9wLmVuZHNXaXRoKE9QX0VSUk9SKSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB0aW1lb3V0KHRoaXMuc29ja2V0VGltZW91dCksXG4gICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgbWVyZ2VNYXAoKGFjdCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHsgc29ja2V0T3AgfSA9IGFjdC5wYXlsb2FkO1xuICAgICAgICAgICAgICAgIHJldHVybiBzb2NrZXRPcC5lbmRzV2l0aChPUF9TVUNDRVNTKVxuICAgICAgICAgICAgICAgICAgICA/IG9mKGFjdC5wYXlsb2FkLmRhdGEgYXMgRClcbiAgICAgICAgICAgICAgICAgICAgOiB0aHJvd0Vycm9yKGFjdC5wYXlsb2FkLmRhdGEuZXJyb3IpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=