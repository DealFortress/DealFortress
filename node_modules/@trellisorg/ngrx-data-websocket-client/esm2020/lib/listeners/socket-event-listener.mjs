import { listeners, SocketOp, } from '@trellisorg/ngrx-data-websocket-core';
import { BehaviorSubject } from 'rxjs';
import socketIo from 'socket.io-client';
export class SocketEventListener {
    constructor(entityName, socketActionFactory, store) {
        this.socketActionFactory = socketActionFactory;
        this.store = store;
        this._entityName = entityName;
    }
    setupReservedEvents() {
        [SocketOp.CONNECT_ERROR, SocketOp.RECONNECT_ERROR].forEach((event) => this._socket.on(event, (err) => this.store.dispatch(this.socketActionFactory.create(this._entityName, event, err))));
        [
            SocketOp.CONNECT_TIMEOUT,
            SocketOp.RECONNECT_ATTEMPT,
            SocketOp.RECONNECT_FAILED,
        ].forEach((event) => this._socket.on(event, (attempts) => this.store.dispatch(this.socketActionFactory.create(this._entityName, event, attempts))));
        [SocketOp.RECONNECT, SocketOp.RECONNECTING].forEach((event) => this._socket.on(event, () => this.store.dispatch(this.socketActionFactory.create(this._entityName, event))));
    }
    emit(event, crid, data) {
        this._socket.emit(event, {
            correlationId: crid,
            data,
        });
    }
    disconnect() {
        this._socket.disconnect();
    }
    connect(config, params) {
        const connected = new BehaviorSubject(false);
        const host = config.host ? `${config.host}/` : '';
        const connectParams = new URLSearchParams(params).toString();
        this._socket = socketIo(`${host}${this._entityName.toLowerCase()}?${connectParams}`, {
            transports: ['websocket', 'polling'],
        });
        this.setupReservedEvents();
        this._socket.on('connect', () => {
            this.store.dispatch(this.socketActionFactory.create(this._entityName, SocketOp.CONNECT));
            connected.next(true);
            connected.complete();
        });
        listeners.forEach((event) => {
            this._socket.on(event, (response) => {
                const { correlationId, data } = response;
                this.store.dispatch(this.socketActionFactory.create(this._entityName, event, data, {
                    correlationId,
                }));
            });
        });
        return connected.asObservable();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LWV2ZW50LWxpc3RlbmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvbmdyeC1kYXRhLXdlYnNvY2tldC9jbGllbnQvc3JjL2xpYi9saXN0ZW5lcnMvc29ja2V0LWV2ZW50LWxpc3RlbmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDSCxTQUFTLEVBRVQsUUFBUSxHQUNYLE1BQU0sc0NBQXNDLENBQUM7QUFDOUMsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLFFBQVEsTUFBTSxrQkFBa0IsQ0FBQztBQUl4QyxNQUFNLE9BQU8sbUJBQW1CO0lBSzVCLFlBQ0ksVUFBa0IsRUFDVixtQkFBd0MsRUFDeEMsS0FBWTtRQURaLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsVUFBSyxHQUFMLEtBQUssQ0FBTztRQUVwQixJQUFJLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQztJQUNsQyxDQUFDO0lBRUQsbUJBQW1CO1FBQ2YsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNqRSxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUMzQixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FDZixJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUMzQixJQUFJLENBQUMsV0FBVyxFQUNoQixLQUFLLEVBQ0wsR0FBRyxDQUNOLENBQ0osQ0FDSixDQUNKLENBQUM7UUFFRjtZQUNJLFFBQVEsQ0FBQyxlQUFlO1lBQ3hCLFFBQVEsQ0FBQyxpQkFBaUI7WUFDMUIsUUFBUSxDQUFDLGdCQUFnQjtTQUM1QixDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENB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b3J0IHR5cGUgeyBTdG9yZSB9IGZyb20gJ0BuZ3J4L3N0b3JlJztcbmltcG9ydCB7XG4gICAgbGlzdGVuZXJzLFxuICAgIFNvY2tldEFjdGlvblBheWxvYWQsXG4gICAgU29ja2V0T3AsXG59IGZyb20gJ0B0cmVsbGlzb3JnL25ncngtZGF0YS13ZWJzb2NrZXQtY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCBzb2NrZXRJbyBmcm9tICdzb2NrZXQuaW8tY2xpZW50JztcbmltcG9ydCB0eXBlIHsgU29ja2V0QWN0aW9uRmFjdG9yeSB9IGZyb20gJy4uL2FjdGlvbnMvc29ja2V0LWFjdGlvbi1mYWN0b3J5JztcbmltcG9ydCB0eXBlIHsgTmdyeERhdGFXZWJzb2NrZXRDb25maWcgfSBmcm9tICcuLi91dGlscy90b2tlbnMnO1xuXG5leHBvcnQgY2xhc3MgU29ja2V0RXZlbnRMaXN0ZW5lcjxUPiB7XG4gICAgcHJpdmF0ZSBfc29ja2V0OiBhbnk7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IF9lbnRpdHlOYW1lOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgZW50aXR5TmFtZTogc3RyaW5nLFxuICAgICAgICBwcml2YXRlIHNvY2tldEFjdGlvbkZhY3Rvcnk6IFNvY2tldEFjdGlvbkZhY3RvcnksXG4gICAgICAgIHByaXZhdGUgc3RvcmU6IFN0b3JlXG4gICAgKSB7XG4gICAgICAgIHRoaXMuX2VudGl0eU5hbWUgPSBlbnRpdHlOYW1lO1xuICAgIH1cblxuICAgIHNldHVwUmVzZXJ2ZWRFdmVudHMoKTogdm9pZCB7XG4gICAgICAgIFtTb2NrZXRPcC5DT05ORUNUX0VSUk9SLCBTb2NrZXRPcC5SRUNPTk5FQ1RfRVJST1JdLmZvckVhY2goKGV2ZW50KSA9PlxuICAgICAgICAgICAgdGhpcy5fc29ja2V0Lm9uKGV2ZW50LCAoZXJyKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0QWN0aW9uRmFjdG9yeS5jcmVhdGU8RXJyb3I+KFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW50aXR5TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgW1xuICAgICAgICAgICAgU29ja2V0T3AuQ09OTkVDVF9USU1FT1VULFxuICAgICAgICAgICAgU29ja2V0T3AuUkVDT05ORUNUX0FUVEVNUFQsXG4gICAgICAgICAgICBTb2NrZXRPcC5SRUNPTk5FQ1RfRkFJTEVELFxuICAgICAgICBdLmZvckVhY2goKGV2ZW50KSA9PlxuICAgICAgICAgICAgdGhpcy5fc29ja2V0Lm9uKGV2ZW50LCAoYXR0ZW1wdHMpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zb2NrZXRBY3Rpb25GYWN0b3J5LmNyZWF0ZTxudW1iZXI+KFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW50aXR5TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdHNcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICBbU29ja2V0T3AuUkVDT05ORUNULCBTb2NrZXRPcC5SRUNPTk5FQ1RJTkddLmZvckVhY2goKGV2ZW50KSA9PlxuICAgICAgICAgICAgdGhpcy5fc29ja2V0Lm9uKGV2ZW50LCAoKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0QWN0aW9uRmFjdG9yeS5jcmVhdGU8dm9pZD4oXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9lbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBlbWl0KGV2ZW50OiBTb2NrZXRPcCwgY3JpZDogc3RyaW5nLCBkYXRhOiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fc29ja2V0LmVtaXQoZXZlbnQsIHtcbiAgICAgICAgICAgIGNvcnJlbGF0aW9uSWQ6IGNyaWQsXG4gICAgICAgICAgICBkYXRhLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBkaXNjb25uZWN0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLl9zb2NrZXQuZGlzY29ubmVjdCgpO1xuICAgIH1cblxuICAgIGNvbm5lY3QoXG4gICAgICAgIGNvbmZpZzogTmdyeERhdGFXZWJzb2NrZXRDb25maWcsXG4gICAgICAgIHBhcmFtczogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuICAgICk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCBjb25uZWN0ZWQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcbiAgICAgICAgY29uc3QgaG9zdCA9IGNvbmZpZy5ob3N0ID8gYCR7Y29uZmlnLmhvc3R9L2AgOiAnJztcblxuICAgICAgICBjb25zdCBjb25uZWN0UGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyhwYXJhbXMpLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgdGhpcy5fc29ja2V0ID0gc29ja2V0SW8oXG4gICAgICAgICAgICBgJHtob3N0fSR7dGhpcy5fZW50aXR5TmFtZS50b0xvd2VyQ2FzZSgpfT8ke2Nvbm5lY3RQYXJhbXN9YCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0cmFuc3BvcnRzOiBbJ3dlYnNvY2tldCcsICdwb2xsaW5nJ10sXG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5zZXR1cFJlc2VydmVkRXZlbnRzKCk7XG5cbiAgICAgICAgdGhpcy5fc29ja2V0Lm9uKCdjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICAgICAgICB0aGlzLnNvY2tldEFjdGlvbkZhY3RvcnkuY3JlYXRlPHZvaWQ+KFxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9lbnRpdHlOYW1lLFxuICAgICAgICAgICAgICAgICAgICBTb2NrZXRPcC5DT05ORUNUXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbm5lY3RlZC5uZXh0KHRydWUpO1xuICAgICAgICAgICAgY29ubmVjdGVkLmNvbXBsZXRlKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGxpc3RlbmVycy5mb3JFYWNoKChldmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fc29ja2V0Lm9uKFxuICAgICAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2U6IFBpY2s8XG4gICAgICAgICAgICAgICAgICAgICAgICBTb2NrZXRBY3Rpb25QYXlsb2FkLFxuICAgICAgICAgICAgICAgICAgICAgICAgJ2RhdGEnIHwgJ2NvcnJlbGF0aW9uSWQnXG4gICAgICAgICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBjb3JyZWxhdGlvbklkLCBkYXRhIH0gPSByZXNwb25zZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0QWN0aW9uRmFjdG9yeS5jcmVhdGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZW50aXR5TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29ycmVsYXRpb25JZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGNvbm5lY3RlZC5hc09ic2VydmFibGUoKTtcbiAgICB9XG59XG4iXX0=